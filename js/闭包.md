# é—­åŒ…
2021-05-29

#### ä¸»è¦å†…å®¹

1. ç®€å•ä»‹ç»é—­åŒ…
2. å®ç°ä¸€ä¸ªç®€æ˜“çš„reduxï¼š[mini-redux](./code/closureInMiniRedux.js)ï¼Œå¹¶åœ¨mini-reduxçš„åŸºç¡€ä¸Šå®ç°ä¸€ä¸ªbatchUpdate
<!-- 3. åˆ©ç”¨é—­åŒ…å°è£…ä¸€ä¸ªç®€å•çš„æ¨¡å— -->

é€šä¿—ç®€å•åœ°è¯´ï¼Œå½“ä¸€ä¸ªå‡½æ•°èƒ½å¤Ÿè®¿é—®å¦ä¸€ä¸ªå‡½æ•°ä¸­å®šä¹‰çš„å†…éƒ¨å˜é‡æ—¶ï¼Œå°±äº§ç”Ÿäº†é—­åŒ…ğŸ˜€

> å½“å‡½æ•°å¯ä»¥è®°ä½å¹¶è®¿é—®æ‰€åœ¨çš„è¯æ³•ä½œç”¨åŸŸï¼Œå³ä½¿å‡½æ•°æ˜¯åœ¨å½“å‰è¯æ³•ä½œç”¨åŸŸä¹‹å¤–æ‰§è¡Œï¼Œè¿™æ—¶å°±äº§ç”Ÿäº†é—­åŒ…ã€‚ --ã€Šä½ ä¸çŸ¥é“çš„JavaScriptï¼ˆä¸Šï¼‰ã€‹ç¬¬ä¸€éƒ¨åˆ†ç¬¬äº”ç« 5.6å°ç»“(57é¡µ)

éå¸¸å¸¸è§çš„ä¸€ä¸ªåœºæ™¯å°±æ˜¯ä½¿ç”¨å›è°ƒå‡½æ•°

```js
// åœ¨react hookçš„å¼€å‘ä¸­ï¼Œå°±ä¼šç»å¸¸ä½¿ç”¨
function App() {
  const [state, setState] = useState(0);

  useEffect(() => {
    // do something...
    console.log(state); // è¿™é‡Œå°±åœ¨å›è°ƒä¸­åˆ©ç”¨é—­åŒ…ç‰¹æ€§è·å–äº†state
  }, [state]);

  // ....
}

// å¼‚æ­¥å›è°ƒä¹Ÿä¸€æ ·
function fun(params) {
  setTimeout(() => {
    console.log(params);
  });
}
fun('23333');

// ç»å…¸çš„varå˜é‡å¾ªç¯é—®é¢˜ï¼Œå½“ç„¶ç°åœ¨åŸºæœ¬ä¸Šä¸ä½¿ç”¨varå£°æ˜å˜é‡ï¼Œè¿™ä¸ªé—®é¢˜ç›´æ¥ä½¿ç”¨letå°±æå®š
for (var i = 0; i < 3; i++) {
  (function iife(j) {
    setTimeout(() => {
      console.log(i, j);
    });
  })(i);
}
```

åˆ©ç”¨é—­åŒ…å¯ä»¥å®ç°jsçš„æ¨¡å—æ¨¡å¼ã€‚å½“ç„¶ç°åœ¨æœ€æ¨èæ˜¯å†™esmï¼Œä¸è¿‡esmå¯¼å‡ºå‡½æ•°è®¿é—®æ¨¡å—å†…éƒ¨æœªå¯¼å‡ºçš„å˜é‡å¯¹è±¡ï¼Œè¿™æ—¶ä¸ªäººæ„Ÿè§‰ä¹Ÿæ˜¯é—­åŒ…ğŸ˜€

```js
const MyModule = (function creator() {
  let privateName = 'my-module';

  return {
    getName: () => privateName,
    setName: newName => {
      privateName = newName;
    },
    say: () => {
      console.log(`hello, ${privateName}`);
    },
  };
})();
MyModule.getName() // my-module
```

### é—­åŒ…åœ¨reduxä¸­çš„åº”ç”¨

```js
// å®Œæ•´ä»£ç è§ /code/closireInMiniRedux.js
function createStore(reducer, initialState) {
  // åç»­é€šè¿‡store.dispatch()è§¦å‘æ›´æ–°æ—¶ï¼Œæ— è®ºåœ¨å“ªè°ƒç”¨ï¼Œéƒ½èƒ½å¤Ÿè®¿é—®åˆ°å†…éƒ¨çš„stateå˜é‡
  let state = reducer(initialState, {});
  const dispatch = (action) => {
    // ....
    state = reducer(state, action);
    // ....
  };
  
  const listener = [];
  const subscribe = (cb) => {
    // ....
    // é€€è®¢æ—¶ï¼Œåˆ©ç”¨é—­åŒ…è®¿é—®äº†cbå’Œlisteneræ•°ç»„
    return function unsubscribe() {
      // ....
    }
  };

  const getState = () => state;

  return {
    getState,
    dispatch,
    subscribe,
  };
}
```

### batchUpdate

åœ¨æ‰¹é‡æ›´æ–°ä¸­ï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªä»»åŠ¡ä¸­è§¦å‘å¤šæ¬¡æ›´æ–°ï¼Œå¤–éƒ¨ç›‘å¬è€…åªèƒ½æ¥æ”¶åˆ°ä¸€æ¬¡æ›´æ–°

ç¬¬ä¸€æ¬¡å°è¯•ï¼šå¾ˆè‡ªç„¶åˆ©ç”¨äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œå»¶è¿Ÿæ›´æ–°ã€‚å…ˆå°†store.dispatchè¿›è¡Œå¤„ç†ï¼Œè¿™æ ·è¿ç»­è§¦å‘çš„æ›´æ–°å°†è¢«æ”¶é›†èµ·æ¥ï¼Œç„¶ååˆ©ç”¨å¼‚æ­¥å›è°ƒï¼ˆPromise.resolveæˆ–è€…setTimeoutï¼‰å»è°ƒç”¨çœŸå®çš„store.dispatchè¿›è¡Œæ›´æ–°

```js
// å®Œæ•´ä»£ç è§ /code/closireInMiniRedux.js
// ....

function useBatchUpdate(_dispatch) {
  let dispatching = false;
  let payload = {};

  return function wrap(newState) {
    // å°†æ¯æ¬¡è§¦å‘çš„stateæ”¶é›†èµ·æ¥
    // è¿™æ ·å¼‚æ­¥æ›´æ–°æ—¶ï¼Œå°±æ˜¯åˆ©ç”¨é—­åŒ…è·å–æœ€æ–°çš„payloadå»æ›´æ–°state
    payload = {
      ...payload,
      ...newState,
    };

    if (dispatching) return;
    dispatching = true;

    // åœ¨ç´§æ¥çš„å¾®ä»»åŠ¡é‡Œé¢æ›´æ–°
    // return Promise.resolve().then(() => {
    //   dispatching = false;
    //   _dispatch(payload);
    // });

    // ä¸‹ä¸€è½®å®ä»»åŠ¡æ‰æ›´æ–°
    setTimeout(() => {
      dispatching = false;
      _dispatch(payload);
    });
  }
}
const setState = useBatchUpdate(payload => store.dispatch({ type: UpdateKey, payload, }));
```

ç¬¬äºŒæ¬¡å°è¯•ï¼šä½¿ç”¨`pendingUpdates`æ•°ç»„æ›¿æ¢åŸæ¥çš„`payload`å¯¹è±¡ï¼Œå°†æ–°stateçš„è®¡ç®—æ”¾åœ¨å®é™…è§¦å‘æ›´æ–°ä¹‹å‰ã€‚

```js
function useBatchUpdate(_dispatch, store) {
  let dispatching = false;
  const pendingUpdates = []; // ä½¿ç”¨æ•°ç»„ä¿å­˜è¿ç»­è§¦å‘çš„æ›´æ–°ï¼Œç°åœ¨æ”¯æŒä¼ å…¥å‡½æ•°äº†

  return function wrap(_updateObjectOrCallback) {
    pendingUpdates.push(_updateObjectOrCallback);

    if (dispatching) return;
    dispatching = true;

    const callback = () => {
      // å¦‚æœæ˜¯å‡½æ•°ï¼Œå°±å°†æœ€æ–°çš„stateä½œä¸ºå‚æ•°ä¼ å…¥
      // è¿™é‡Œå®é™…ä¸Šå·²ç»ç®—æ˜¯å®Œæˆstore.dispatchçš„å·¥ä½œäº†ğŸ˜
      let newState = store.getState();
      for (const update of pendingUpdates) {
        const updateState = typeof update === 'function'
          ? update(newState)
          : update;
        newState = { ...newState, ...updateState };
      }

      dispatching = false;
      pendingUpdates.length = 0;
      _dispatch(newState);
    };

    // ä¸‹ä¸€è½®å®ä»»åŠ¡æ‰æ›´æ–°
    setTimeout(callback);
    // Promise.resolve().then(callback);
  }
}
const setState = useBatchUpdate(
  payload => store.dispatch({ type: UpdateKey, payload, }),
  store,
);
```

è¿è¡Œç»“æœï¼š

ç¬¬ä¸€æ¬¡å°è¯•çš„æµ‹è¯•ç»“æœï¼š

![wdnmdï¼Œå›¾ç‰‡åˆæŒ‚äº†](./img/batch-update-result.jpg 'result')

ç¬¬äºŒæ¬¡å°è¯•çš„æµ‹è¯•ç»“æœï¼š

![wdnmdï¼Œå›¾ç‰‡åˆæŒ‚äº†](./img/batch-update-result2.jpg 'result')

> ##
> ### å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£
> ##